name: RAVA actions

on:
  workflow_call:   
    secrets:
      lava_token:
        required: true

jobs:
  parse-request:
    runs-on: 'ubuntu-latest'
    outputs:
      lava_template: ${{ steps.parse.outputs.lava_template }}
      lava_testcase_path: ${{ steps.parse.outputs.lava_testcase_path }}
      testcase_repo: ${{ steps.parse.outputs.testcase_repo }}
      testcase_ref: ${{ steps.parse.outputs.testcase_ref }}
      summary: ${{ steps.parse.outputs.summary || steps.onfailure.outputs.summary }}
      is_check: ${{ steps.parse.outputs.is_check }}
      codelint_check_path: ${{ steps.parse.outputs.codelint_check_path }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_REPO: ${{ github.repository }}
      event_name: ${{ github.event_name }}
      event_info: ${{ toJson(github.event) }}
    steps:
      - id: parse
        run: |
          function parse_pr() {
            title="$1"
            echo is_check=true >> $GITHUB_OUTPUT
            # title=[lava-job-template/qemu/qemu.yaml]-[lava-testcases/common-test/ltp/ltp.yaml]: xxx
            if [ "$lava_template" = "" ]; then
              lava_template=$(echo "$title" | awk -F'\\]-\\[' '{print $1}')
              lava_template="${lava_template#\[}"
              lava_template="${lava_template%\]*}"
            fi
            if [ "$lava_testcase_path" = "" ]; then
              lava_testcase_path=$(echo "$title" | awk -F'\\]-\\[' '{print $2}')
              lava_testcase_path="${lava_testcase_path#\[}"
              lava_testcase_path="${lava_testcase_path%\]*}"
            fi

            ## pr 强制使用当前分支，不允许指定 / issue_comment略过
            _pr_id="${{ github.event.number || github.event.issue.number }}"
            testcase_repo="$(gh pr view "$_pr_id" --json headRepositoryOwner -q '.headRepositoryOwner.login')/$(gh pr view "$_pr_id" --json headRepository -q '.headRepository.name')"
            testcase_ref=$(gh pr view "$_pr_id" --json headRefOid -q .headRefOid)
          }

          function parse_comment() {
            comment_body="$1"
            if [ "${comment_body:0:6}" != '/check' ]; then
              return -1
            fi
            echo is_check=true >> $GITHUB_OUTPUT
            lava_template="$(echo "$comment_body" | awk -F'lava_template=' '{print $2}' | awk '{print $1}')"
            lava_testcase_path="$(echo "$comment_body" | awk -F'testcase_path=' '{print $2}' | awk '{print $1}')"
          }
          
          set -x
          if [ "$event_name" = 'pull_request' ] || [ "$event_name" = 'pull_request_target' ]; then
            parse_pr "${{ github.event.pull_request.title }}"
          elif [ "$event_name" = 'issues' ]; then
            parse_comment "${{ github.event.issue.body }}" || exit 0
          elif [ "$event_name" = 'issue_comment' ]; then
            parse_comment "${{ github.event.comment.body }}" || exit 0
            if [ "${{ github.event.issue.pull_request }}" != "" ]; then
              # pr comment
              parse_pr "${{ github.event.issue.title }}"
            fi
          else
            echo "不支持的事件类型 $event_name, ignore"
            exit 0
          fi
          set +x
          testcase_repo=${testcase_repo:-${{ github.repository }}}

          echo "lava_template=$lava_template" >> $GITHUB_OUTPUT
          echo "lava_testcase_path=$lava_testcase_path" >> $GITHUB_OUTPUT
          echo "testcase_repo=${testcase_repo}" >> $GITHUB_OUTPUT
          echo "testcase_ref=${testcase_ref}" >> $GITHUB_OUTPUT
          
          echo "codelint_check_path<<EOF" >> $GITHUB_OUTPUT
          echo "${lava_template}" >> $GITHUB_OUTPUT
          dirname "${lava_testcase_path}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          log_url=$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID
          cat > summary << EOF
          ---
          
          **开始检查, log: [$log_url]($log_url)**
          
          <details>
          
          <summary>参数解析结果</summary>
          
          |args|value|
          |:-:|:-:|
          |repository | $GH_REPO |
          |LAVA Template | $lava_template |
          |Testcase path | $lava_testcase_path |
          |Testcase repo | $testcase_repo |
          |Testcase ref | $testcase_ref |

          </details>
          ---
          EOF

          echo "summary<<EOF" >> $GITHUB_OUTPUT
          cat summary >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          cat summary >> $GITHUB_STEP_SUMMARY
      - id: onfailure
        if: ${{ failure() && steps.parse.is_check == 'true' }}
        run: |
          log_url=$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID
          cat > summary << EOF
          ---
          参数解析失败, log: [$log_url]($log_url)
          ---
          EOF
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          cat summary >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  
  pre-check:
    needs: [parse-request]
    if: ${{ !cancelled() && github.event_name != 'pull_request_target' && needs.parse-request.outputs.is_check == 'true' }}
    permissions:
      issues: write
      pull-requests: write
    uses: ./.github/workflows/update-status.yml
    secrets: 
      gh_token: ${{ secrets.github_token }}
    with:
      repo: ${{ github.repository }}
      event_name: ${{ github.event_name }}
      event_id: ${{ github.event_name == 'issue_comment' && github.event.comment.id || github.event.number || github.event.issue.number }}
      append_content: ${{ needs.parse-request.outputs.summary }}

  
  run-lava-check:
    needs: [parse-request]
    if: ${{ needs.parse-request.outputs.lava_template && needs.parse-request.outputs.lava_testcase_path }}
    uses: ./.github/workflows/lava-trigger.yml
    secrets:
      lava_token: ${{ secrets.lava_token }}
    with:
      kernel_download_url: 'https://fast-mirror.isrc.ac.cn/openeuler-sig-riscv/openEuler-RISC-V/RVCK/OERV-RVCI/rvck-olk/latest/Image'
      testcase_repo: ${{ needs.parse-request.outputs.testcase_repo }}
      testcase_ref: ${{ needs.parse-request.outputs.testcase_ref }}
      lava_template: ${{ needs.parse-request.outputs.lava_template }}
      testcase_path: ${{ needs.parse-request.outputs.lava_testcase_path }}
  
  run-codelint:
    needs: [parse-request]
    if: ${{ needs.parse-request.outputs.codelint_check_path }}
    uses: ./.github/workflows/codelint.yml
    with:
      repo: ${{ needs.parse-request.outputs.testcase_repo }}
      ref: ${{ needs.parse-request.outputs.testcase_ref || 'main' }}
      check_path: ${{ needs.parse-request.outputs.codelint_check_path }}
  
  collect-result:
    needs: [run-lava-check, run-codelint]
    if: ${{ !cancelled() }}
    permissions:
      issues: write
      pull-requests: write
    uses: ./.github/workflows/update-status.yml
    secrets: 
      gh_token: ${{ secrets.github_token }}
    with:
      repo: ${{ github.repository }}
      event_name: ${{ github.event_name }}
      event_id: ${{ github.event_name == 'issue_comment' && github.event.comment.id || github.event.number || github.event.issue.number }}
      append_content: |
        <details>

        <summary>RAVA actions 测试结果</summary>
        
        # RAVA actions result

        ${{ needs.run-lava-check.outputs.summary_content }}
        
        ${{ needs.run-codelint.outputs.summary_content }}
        
        </details>
  